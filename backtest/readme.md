# 交易回测分析模块

## 模块简介

交易回测分析模块是 Tretra Trading Station 的核心组件之一，基于 Streamlit 构建，用于导入和分析历史交易数据。系统可以处理来自币安、OKX 等交易所的 CSV 交易记录，进行数据清洗、订单聚合和深度分析。

## 功能特点

### 1. 数据导入与管理
- 支持 CSV 文件上传（币安、OKX 格式）
- 智能订单聚合（60秒窗口，1%价格容差）
- 历史记录管理：最近3次分析记录一键加载
- 数据持久化存储到 SQLite 数据库

### 2. 交易统计分析
- **核心指标**: 胜率、盈亏比、夏普比率、最大回撤
- **交易频率**: 日均交易次数、持仓时长分布
- **盈亏分析**: 总收益、平均收益、最大单笔盈亏

### 3. 数据可视化
- 累计收益曲线
- 盈亏分布图（柱状图、饼图）
- 交易频率热力图
- 持仓时长分析

### 4. 多维度筛选
- 按年度筛选交易数据
- 按交易对筛选
- 按时间范围筛选

### 5. 导出功能
- Excel 导出分析结果
- 支持自定义导出字段

## 访问方式

### Docker 部署（推荐）
回测分析模块作为 Docker 服务运行，通过前端界面访问：

1. 启动所有服务：
   ```bash
   docker-compose up -d
   ```

2. 访问前端界面：http://localhost:3000

3. 点击顶部导航栏的「交易回测分析」

4. 或直接访问：http://localhost:8501

### 本地开发
```bash
cd backtest
pip install -r requirements.txt
streamlit run upgraded.py --server.port 8501
```

## 使用指南

### 1. 上传交易数据
- 点击「上传CSV文件」
- 选择从交易所导出的交易历史 CSV 文件
- 系统自动识别文件格式并处理

### 2. 选择分析范围
- 使用侧边栏选择年度（可选「全部年份」）
- 选择交易对（支持多选或全选）

### 3. 查看分析结果
- **概览面板**: 核心交易指标一览
- **盈亏分析**: 详细的盈亏统计和分布
- **时间分析**: 按日期、按小时的交易分布
- **交易明细**: 完整的交易记录列表

### 4. 导出报告
- 点击「导出Excel」按钮
- 下载包含完整分析结果的 Excel 文件

## 数据格式要求

### 币安格式
CSV 文件需包含以下字段：
- Date(UTC) / 时间
- Pair / 交易对
- Side / 方向
- Price / 价格
- Executed / 数量
- Fee / 手续费

### OKX 格式
CSV 文件需包含以下字段：
- 时间
- 交易对
- 方向
- 成交价格
- 成交数量
- 手续费

## 技术栈

- **框架**: Streamlit
- **数据处理**: Pandas, NumPy
- **可视化**: Plotly
- **数据库**: SQLAlchemy, SQLite
- **导出**: openpyxl

## 系统要求

- Python 3.9+
- 依赖包见 requirements.txt
- Docker 环境（推荐）

## 目录结构

```
backtest/
├── upgraded.py          # Streamlit 主应用
├── requirements.txt     # Python 依赖
├── .streamlit/          # Streamlit 配置
│   └── config.toml
└── readme.md            # 本文档
```

## 常见问题

### Q: 如何获取交易所交易记录？
**币安**: 登录 → 订单 → 交易历史 → 导出

**OKX**: 登录 → 资产 → 交易记录 → 导出

### Q: 数据上传后为什么显示交易次数变少了？
系统会自动合并时间相近的拆单订单（60秒内、价格误差1%以内的订单会被合并），显示的是实际交易次数。

### Q: 如何重新分析之前的数据？
在侧边栏「历史记录」中选择之前的分析记录，点击「加载」即可。

---

> 本模块是 Tretra Trading Station v1.2+ 的组成部分
